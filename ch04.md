
## 4. 외부와 상호작용하는 어댑터 만들기

### 어댑터 이해
헥사고날 아키텍처에서는 시스템이 다른 기술이나 프로토콜과 호환되게 만들기 위해 어댑터를 사용한다.  
애플리케이션 기능을 노출하는 데 사용되는 어댑터를 입력 어댑터라고 한다.
핵사고날 애플리케이션에서 생성된 데이터를 변환하고 외부 시스템과 통신하기 위한 어댑터를 출력 어댑터라고 한다.

### 드라이빙 오퍼레이션 허용을 위한 입력 어댑터 사용
애플리케이션 유스케이스를 형성하는 중추 역할을 하는  
헥사곤 외부에서 헥사곤 애플리케이션과 상호작용하는 사용자나 시스템을 주요 액터라고 한다.  
주요 액터와 헥사고날 애플리케이션 사이의 상호작용은 입력 어댑터를 통해 일어나며  
이런 상호작용은 드라이빙 오퍼레이션으로 정의된다.


### 입력 어댑터 생성
라우터에 네크워크를 추가하는 유스케이스  
다른 형식으로 들어오는 요청 처리에 같은 로직을 사용하게 해야한다.
- HTTP REST 통신을 위한 어댑터 
    - HTTP REST 연결에서 데이터를 수신
- 명령령 실행을 위한 어댑터
    - 콘솔 STDIN 연결 

#### 추상 기반 클래스 정의
```
public abstract class RouterNetworkAdapter {

    protected Router router;
    protected RouterNetworkUseCase routerNetworkUseCase;

    protected Router addNetworkToRouter(Map<String, String> params){
        var routerId = RouterId.withId(params.get("routerId"));
        var network = new Network(IP.fromAddress(params.get("address")),
                params.get("name"),
                Integer.valueOf(params.get("cidr")));
        return routerNetworkUseCase.addNetworkToRouter(routerId, network);
    }

    public abstract Router processRequest(Object requestParams);
}
```
RouterId와 Network 객체를 만드는데 필요한 매개변수를 수신하기 위해 addNetworkToRouter 어댑터 메서드를 사용하고 이 객체들은 라우터에 네트워크를 추가하는 유스케이스 오퍼레이션을 시작하는 데 사용한다.

입력 포트를 직접 참조하지 않고 유스케이스 인터페이스 참조를 활용하며  
유스케이스 참조는 입력 어댑터의 생성자에 의해 전달되고 초기화된다.

#### REST 입력 어댑터
- RouterNetworkUseCase 유스케이스 참조를 수신하고 초기화하기 위해   RouterNetworkRestAdapter 생성자 사용

- processRequest 메서드 구현
```
public class RouterNetworkRestAdapter extends RouterNetworkAdapter {

    public RouterNetworkRestAdapter(RouterNetworkUseCase routerNetworkUseCase){
        this.routerNetworkUseCase = routerNetworkUseCase;
    }

    @Override
    public Router processRequest(Object requestParams){
        /** 코드 생략 **/
    }
}
```
- 클라이언트 입력 어댑터 사용
```
RouterNetworkOutputPort outputPort = RouterNetworkH2Adapter.getInstance();
RouterNetworkUseCase usecase = new RouterNetworkInputPort(outputPort);
RouterNetworkAdapter inputAdapter= new RouterNetworkRestAdapter(usecase);
```

### 다양한 데이터 소스와 통신하기 위한 출력 어댑터 사용
데이터베이스(RDBMS, NoSQL) 외에도 데이터 처리에 대한 소프트웨어 요구사항을 만족시키는 다른 데이터 소스가 사용되고 있다.(ex) 파일 시스템, 메시지 브로커, 디렉터리 기반 스토리지(LDAP), 메인프레임 스토리지)
클라우드 컴퓨팅 세계에서는 데이터를 주고 받기 위해 다양한 기술과 통합하는 것이 자연스러워 지고 있는데 이러한 변화에 극복하는 기술이 필요하다. (-> 헥사고날 애플리케이션)

### 출력 어댑터 생성
출력 어댑터의 역할은 드리븐 오퍼레이션을 처리하는 것이다.
드리븐 오퍼레이션은 유스케이스를 통해 서술되며 유스케이스의 입력 포트에 구현에 있는 오퍼레이션에 의해 트리거 된다.

출력포트는 외부 시스템과의 상화작용을 추상적인 방법으로 표현하고  
출력어댑터는 이러한 상호작용이 발생하는 방법을 구체적인 용어로 설명할 책임이 있으며  
시스템이 데이터 지속성과 기타 유형의 외부통합을 허용하기 위해 사용할 수 있는 기술을 결정할 수 있다.

#### 출력 어댑터 예제
- RouterNetworkOutputPort : 출력 포트
```
public interface RouterNetworkOutputPort {
    Router fetchRouterById(RouterId routerId);

    boolean persistRouter(Router router);
}
```
- RouterNetworkH2Adapter : 인메모리 데이터베이스 처리
- RouterNetworkFileAdapter : 로컬 파일 시스템 처리

RouterNetworkH2Adapter 클래스 생성후 RouterNetworkH2Adapter 구현  
출력 어댑터를 만들기 위한 유일한 요구사항은 애플리케이션 헥사곤에서 출력 포트 인터페이스를 구현하는 것이다.  
```
public class RouterNetworkH2Adapter implements RouterNetworkOutputPort {

    private static RouterNetworkH2Adapter instance;

    @PersistenceContext
    private EntityManager em;

    private RouterNetworkH2Adapter(){
        setUpH2Database();
    }

    @Override
    public Router fetchRouterById(RouterId routerId) {
        var routerData = em.getReference(RouterData.class, routerId.getUUID());
        return RouterH2Mapper.toDomain(routerData);
    }

    @Override
    public boolean persistRouter(Router router) {
        var routerData = RouterH2Mapper.toH2(router);
        em.persist(routerData);
        return true;
    }

    private void setUpH2Database() {
        EntityManagerFactory entityManagerFactory = Persistence.createEntityManagerFactory("inventory");
        EntityManager em = entityManagerFactory.createEntityManager();
        this.em = em;
    }

    public static RouterNetworkH2Adapter getInstance() {
        if (instance == null) {
            instance = new RouterNetworkH2Adapter();
        }
        return instance;
    }
}
```

### 요약
입력 어댑터를 통해 같은 입력 포트로 서로 다른 형식의 요청을 처리 할 수 있었고  
출력 어댑터를 통해 다른 외부 소스의 데이터를 얻을 수 있었다.  
입력 어댑터와 출력 어댑터의 목적을 알고 구현 방법을 이해함으로써  
큰 큐모의 리팩터링 없이 기술적 변화에 적응할 수 있는 시스템을 만들수 있다.  
이러한 혜택은 어댑터를 포함하는 모든 시스템 컴포넌트가 도메인 모델을 중심으로 개발되기 때문에 얻을 수 있다. 


