## 7. 애플리케이션 헥사곤 만들기
- 애플리케이션 헥사곤 생성
- 유스케이스 정의
- 유스케이스와 입력 포트 구현
- 애플리케이션 헥사곤 테스트

### 애플리케이션 헥사곤 생성
애플리케이션 헥사곤은 도메인 헥사곤을 통한 내부 요청과 프레임워크 헥사곤을 통한 외부 요청을 조정한다.  
제어조건이나 비즈니스 규칙을 정의하지 않는다.

애플리케이션의 메이븐 모듈과 자바 모듈 구성


### 유스케이스 정의 
예제 시스템에서는 라우터, 스위치, 네트워크 같은 리소스 관리
유스케이스는 큐컴버로 디스크립트 작성

라우터 관리 유스케이스에 대한 디스크립션 작성
```
@RouterAdd
Feature: 코어 라우터에 에지 라우터를 추가할 수 있는 가?
  Scenario: 코어 라우터에 에지 라우터 추가
    Given 에지 라우터가 있다.
    And 코어 라우터가 있다.
    Then 코어 라우터에 에지 라우터를 추가한다.
```
라우터 관리를 위한 유스케이스 인테페이스 정의
```
public interface RouterManagementUseCase {

    // 새로운 라우터 추가
    Router createRouter(
            Vendor vendor,
            Model model,
            IP ip,
            Location location,
            RouterType routerType);

    // 코어 라우터에 에지 라우터 추가
    CoreRouter addRouterToCoreRouter(
            Router router, CoreRouter coreRouter);

    // 코어 라우터에서 에지 라우터 제거    
    Router removeRouterFromCoreRouter(
            Router router, CoreRouter coreRouter);

    Router retrieveRouter(Id id);
    Router persistRouter(Router router);
}
```
스위치 관리, 네트워크 관리자도 유스케이스에 대한 드스크립션 생성 -> 인터페이스 정의

### 입력 포트를 갖는 유스케이스 구현
입력 포트는 헥사곤과 프레임워크 헥사곤 사이의 간근을 입력 포트를 통해 메운다.  
외부 테이터는 출력 포트로 가져오고 출력 포트를 사용해 해당 데이터를 도메인 헥사곤으로 전달한다.

출력포트는 선언만 해둔다. 프레임 워크 헥사곤이 구현체를 제공할때 애플리케이션 헥사곤이 동작하도록 준비만 하고 있다.
RouterManagementOutputPort 필드를 선언만 해둔다.ㄴ  
```
@NoArgsConstructor
public class RouterManagementInputPort implements RouterManagementUseCase {

    RouterManagementOutputPort routerManagementOutputPort;

    @Override
    public Router createRouter(Vendor vendor,
                               Model model,
                               IP ip,
                               Location location,
                               RouterType routerType) {

        // 도메인 헥사곤에 RouterFactory라는 팩터리 메서드를 직접 제공.                      
        return RouterFactory.getRouter(null,
                vendor, model, ip, location, routerType);
    }
    @Override
    public Router retrieveRouter(Id id) {
        return routerManagementOutputPort.retrieveRouter(id);
    }

    @Override
    public Router persistRouter(Router router) {
        return routerManagementOutputPort.persistRouter(router);
    }

    @Override
    public CoreRouter addRouterToCoreRouter(Router router, CoreRouter coreRouter) {
        var addedRouter =  coreRouter.addRouter(router);
        return addedRouter;
    }
    @Override
    public Router removeRouterFromCoreRouter(Router router, CoreRouter coreRouter) {
        var removedRouter = coreRouter.removeRouter(router);
        return removedRouter;
    }
}
```
getRouter 메서드에 전달하는 매개변수는 CORE, EDGE 만 갖는다.
매개변수별로 어떤 빌더 메서드를 사용할지 결정할ㄴ다.
```
public class RouterFactory {

    public static Router getRouter(Id id,
                                   Vendor vendor,
                                   Model model,
                                   IP ip,
                                   Location location,
                                   RouterType routerType){

        switch (routerType){
            case CORE:
                return CoreRouter.builder().
                        id(id==null ? Id.withoutId():id).
                        vendor(vendor).
                        model(model).
                        ip(ip).
                        location(location).
                        routerType(routerType).
                        build();
            case EDGE:
                return EdgeRouter.builder().
                        id(id==null ? Id.withoutId():id).
                        vendor(vendor).
                        model(model).
                        ip(ip).
                        location(location).
                        routerType(routerType).
                        build();
            default:
                return new UnsupportedOperationException("No valid router type informed");
        }
    }
}
```
라우터, 스위치, 네트워크 관리를 위한 입력 포트 구현을 마친다.

### 애플리케이션 헥사곤 데스트
입력포트를 기반으로 큐컴버 테스트를 작성
큐컴버는 테스트 코드에 글로 작성된 시나리오 디스크립션을 사용할 수 있다.

```
public class RouterAdd extends ApplicationTestData {

    CoreRouter anotherCoreRouter;

    public RouterAdd(){
        loadData();
    }

    //Adding an edge router to a core router
    @Given("I have an edge router")
    public void assert_edge_router_exists(){
        edgeRouter = (EdgeRouter) this.routerManagementUseCase.createRouter(
                Vendor.HP,
                Model.XYZ0004,
                IP.fromAddress("20.0.0.1"),
                locationA,
                EDGE
        );
        assertNotNull(edgeRouter);
    }
    @And("I have a core router")
    public void assert_core_router_exists(){
        coreRouter = (CoreRouter) this.routerManagementUseCase.createRouter(
                Vendor.CISCO,
                Model.XYZ0001,
                IP.fromAddress("30.0.0.1"),
                locationA,
                CORE
        );
        assertNotNull(coreRouter);
    }
    @Then("I add an edge router to a core router")
    public void add_edge_to_core_router(){
        var actualEdgeId = edgeRouter.getId();
        var routerWithEdge = (CoreRouter) this.routerManagementUseCase.
                addRouterToCoreRouter(edgeRouter, coreRouter);
        var expectedEdgeId = routerWithEdge.getRouters().get(actualEdgeId).getId();
        assertEquals(actualEdgeId, expectedEdgeId);
    }
    //Adding a core router to another core router
    @Given("I have this core router")
    public void assert_this_core_router_exists(){
        coreRouter = (CoreRouter) this.routerManagementUseCase.createRouter(
                Vendor.CISCO,
                Model.XYZ0001,
                IP.fromAddress("30.0.0.1"),
                locationA,
                CORE
        );
        assertNotNull(coreRouter);
    }
    @And("I have another core router")
    public void assert_another_core_router_exists(){
        anotherCoreRouter = (CoreRouter) this.routerManagementUseCase.createRouter(
                Vendor.CISCO,
                Model.XYZ0001,
                IP.fromAddress("40.0.0.1"),
                locationA,
                CORE
        );
        assertNotNull(anotherCoreRouter);
    }
    @Then("I add a core router to another core router")
    public void add_core_to_core_router(){
        var coreRouterId = coreRouter.getId();
        var routerWithCore = (CoreRouter) this.routerManagementUseCase.
                addRouterToCoreRouter(coreRouter, anotherCoreRouter);
        var expectedCoreId = routerWithCore.
                getRouters().get(coreRouterId).getId();
        assertEquals(coreRouterId, expectedCoreId);
    }
}
```

### 요약
디스크립션으로 작성된 유스케이스를 포함하는 큐컴버 기능 파일을 생성하고  
기능 파일을 참조로 유스케이스 인터페이스를 생성하고  
이를 기반으로 입력 포트를 구현했다.  
마지막으로 큐컴버에 작성된 디스크립션을 기반으로 다시 유스케이스 테스트를 작성하여  
애플리케이션 헥사곤을 구현하고 테스트했다.  